<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><title>Grafana - Timing is Everything. Editor Mode in Grafana 3.0 for the Clock Panel Plugin</title><meta content="Torkel Ödegaard" name="author" /><meta content="width=device-width, initial-scale=1" name="viewport" /><meta content="The leading graph and dashboard builder for visualizing time series metrics." name="description" /><meta content="Grafana, Graphite, Dashboard, InfluxDB, OpenTSDB, Elasticsearch, Metrics, Editor, Composer, Analytics, Graphana, Prometheus" name="keywords" /><link href="/assets/img/fav32.png" rel="icon" /><link href="/assets/stylesheets/all.css" rel="stylesheet" /><link href="//netdna.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet" /><script src="/assets/javascripts/all.js"></script><meta content="Timing is Everything. Editor Mode in Grafana 3.0 for the Clock Panel Plugin" property="og:title" /><meta content="Grafana.org" property="og:site_name" /><meta content="website" property="og:type" /><meta content="http://grafana.org/assets/img/docs/nice_dashboard.png" property="og:image" /></head><body class="blog blog_2016 blog_2016_04 blog_2016_04_15 blog_2016_04_15_clock-plugin-p2"><section class="nav"><div class="row"><nav class="top-bar" data-topbar="1"><ul class="title-area"><li class="name"><a href="/"><img class="no-shadow" src="/assets/img/logo_new_transparent_200x48.png" width="180px" /></a></li><li class="toggle-topbar menu-icon"><a href="#"><span></span></a></li></ul><section class="meta-top-bar-section"><ul><li><a href="http://docs.grafana.org">Docs</a></li><li><a href="/support/">Support</a></li><li><a href="http://grafana.net/plugins">Plugins</a></li><li><a href="/hosting/">Hosting</a></li></ul></section><section class="top-bar-section"><ul class="right"><li><a href="/features/">Features</a></li><li><a href="/community/">Community</a></li><li><a href="/blog/">Blog</a></li><li class="has-form"><a class="button" href="http://play.grafana.org" id="top-bar-demo-button" target="_blank">Live Demo</a></li><li><a href="https://github.com/grafana/grafana" target="_blank" title="Go to github repository"><i class="fa fa-fw fa-github"></i></a</li><li class="has-form"><a class="button" href="/download" id="top-bar-button">Download</a></li></ul></section></nav></div></section><section class="main"><main><div class="page-header"><div class="page-header-bg"></div><div class="row"><div class="large-12 columns"><h1>Timing is Everything. Editor Mode in Grafana 3.0 for the Clock Panel Plugin</h1></div></div><div class="row"><div class="small-9 columns"><h5 class="subheader">Published: April 15, 2016 by Daniel Lee</h5><p id="twitter"><a class="twitter-share-button" data-via="grafana" href="https://twitter.com/share"></a></p><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div><div class="small-3 columns"></div></div></div><div class="page-content row"><div class="large-9 columns image-shadows"><br /><p>In <a href="http://grafana.org/blog/2016/04/08/clock-plugin-p1.html">part 1</a>, I wrote a simple Clock Plugin. However, it&rsquo;s too simple to be usable for most people. In this post, I will show how to make this plugin customizable and at the same time explain more about how plugins can hook into Grafana. To make the clock panel more usable, we should be able to:</p>

<ul>
<li>choose a 12 or 24 hour clock</li>
<li>set the background color</li>
<li>set the font size</li>
<li>set date/time formats </li>
</ul>

<p>Then after that we&rsquo;ll add some more features. Support for time zones and a countdown would be useful additions.</p>

<h2 id="defaults">Defaults</h2>

<p>We define fields to be saved in Grafana by creating values on the panel object of the controller. You can see these values for any panel by choosing View JSON from the settings menu in Grafana. Here&rsquo;s an excerpt from the clock panel json (with some fields removed), the panel data is saved in the panels array:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
  </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Clock"</span><span class="p">,</span><span class="w">
</span><span class="err">...</span><span class="w">
  </span><span class="nt">"rows"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
</span><span class="err">...</span><span class="w">
      </span><span class="nt">"panels"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"bgColor"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgb(132, 151, 130)"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"clockType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"24 hour"</span><span class="p">,</span><span class="w">
</span></code></pre>

<p>In our code we can define panel data by first creating a JavaScript with the default values for the fields and then setting them on the panel object:</p>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">panelDefaults</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">clockType</span><span class="p">:</span> <span class="s1">'24 hour'</span><span class="p">,</span>
  <span class="na">fontSize</span><span class="p">:</span> <span class="s1">'60px'</span><span class="p">,</span>
  <span class="na">fontWeight</span><span class="p">:</span> <span class="s1">'normal'</span><span class="p">,</span>
  <span class="na">bgColor</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">};</span>

<span class="nx">constructor</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$injector</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">super</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$injector</span><span class="p">);</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">panel</span><span class="p">,</span> <span class="nx">panelDefaults</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">updateClock</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>

<p>The Lodash function defaults, which is called in the code above: <code class="prettyprint">_.defaults</code>, sets a default value only if the value is not already set. </p>

<p>We can now use these fields in our controller or module.html template:</p>
<pre class="highlight html"><code><span class="nt">&lt;h2</span> <span class="na">style=</span><span class="s">"font-size: {{ctrl.panel.fontSize}};"</span><span class="nt">&gt;</span>{{ctrl.time}}<span class="nt">&lt;/h2&gt;</span>
</code></pre>

<p>But if we want our users to be able to change these panel values then we need to expose them in the Grafana editor.</p>

<h2 id="editor-mode">Editor Mode</h2>

<p>When you click Edit on a panel, you open Editor mode. This is where we want to add in our options so that a user can customize the clock panel. Every panel has a general tab where you change the title and width etc. We will create a new editor tab beside the general tab with the clock specific options. We won&rsquo;t have to write much code for this new tab as the Grafana conventions mean all we need to is to hook up an Angular template with input fields and Grafana will take care of the rest. Grafana will automatically save the values to the dashboard json and load them without us writing any extra code.</p>

<h2 id="using-events">Using Events</h2>

<p>To add our editor tab we will hook into the event model so that we can add the tab when the <em>init-edit-mode</em> event is triggered. The following code should be added to the constructor of the ClockCtrl class:</p>
<pre class="highlight javascript"><code><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'init-edit-mode'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onInitEditMode</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
</code></pre>

<p>Then we need to create a function called onInitEditMode. The tab is added by calling the controller function, addEditorTab. This function has two parameters; the tab name and the path to a html template for our new editor tab. It can be a bit tricky to figure out the path, the path name will be based on the id that is specified in the plugin.json file. In this case our plugin id is <strong>grafana-clock-panel</strong>. We need to create a new Angular template which we will call editor.html.</p>
<pre class="highlight javascript"><code><span class="nx">onInitEditMode</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">addEditorTab</span><span class="p">(</span><span class="s1">'Options'</span><span class="p">,</span> <span class="s1">'public/plugins/grafana-clock-panel/editor.html'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<h2 id="editor-html-and-css">Editor HTML and CSS</h2>

<p>In our editor.html we will now use Grafana css styles rather than our own. We don&rsquo;t really want to do anything custom here. It should look the same as other tabs in Grafana.</p>

<p>I&rsquo;m using the <a href="https://github.com/grafana/grafana/blob/master/public/sass/components/_gf-form.scss">gf-form css class</a> from Grafana. I have one row with a couple of columns (following the new style in Grafana 3.0). Each column is wrapped in a div like this:</p>
<pre class="highlight html"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"section gf-form-group"</span><span class="nt">&gt;</span>
</code></pre>

<p>Then each pair, label and field is wrapped in a div with a gf-form class.</p>
<pre class="highlight html"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"gf-form"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"gf-form-label width-8"</span><span class="nt">&gt;</span>Font Size<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"gf-form-input width-4"</span> <span class="na">ng-model=</span><span class="s">"ctrl.panel.fontSize"</span> <span class="na">ng-change=</span><span class="s">"ctrl.render()"</span> <span class="na">ng-model-onblur</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>

<p>Note that we there are some Angular attributes here. <em>ng-model</em> will update the panel data. <em>ng-change</em> will render the panel when you change the value. This change will occur on the onblur event due to the <em>ng-model-onblur</em> attribute. This means you can see the effect of your changes on the panel while editing.</p>

<p><img src="/assets/img/blog/clock-panel-editor.png" /></p>

<p>On the editor tab we use a drop down for 12/24 hour clock, an input field for font size and a color picker for the background color.</p>

<p>The drop down/select has its own <em>gf-form-select-wrapper</em> css class and looks like this:</p>
<pre class="highlight html"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"gf-form"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"gf-form-label width-9"</span><span class="nt">&gt;</span>12 or 24 hour<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"gf-form-select-wrapper max-width-9"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">"input-small gf-form-input"</span> <span class="na">ng-model=</span><span class="s">"ctrl.panel.clockType"</span> <span class="na">ng-options=</span><span class="s">"t for t in ['12 hour', '24 hour', 'custom']"</span> <span class="na">ng-change=</span><span class="s">"ctrl.render()"</span><span class="nt">&gt;&lt;/select&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>

<p>The color picker (or spectrum picker) is a component that already exists in Grafana. We use it like this for the background color:</p>
<pre class="highlight html"><code><span class="nt">&lt;spectrum-picker</span> <span class="na">class=</span><span class="s">"gf-form-input"</span> <span class="na">ng-model=</span><span class="s">"ctrl.panel.bgColor"</span> <span class="na">ng-change=</span><span class="s">"ctrl.render()"</span> <span class="nt">&gt;&lt;/spectrum-picker&gt;</span>
</code></pre>

<h2 id="editor-tab-finished">Editor Tab Finished</h2>

<p>And that&rsquo;s it! It really is quite simple to create your own editor tab. To reiterate, this all ties together quite neatly. We specify properties and panel defaults in the constructor for ClockCtrl and these can then be changed in the editor. We don&rsquo;t have to do anything special to save the changes. Grafana takes care of that. </p>

<p>One thing to be aware of  is that panel defaults are used the first time a panel is created to set the initial values of the panel properties. After the panel is saved then the saved value will be used instead. So beware if you update panel defaults they will not automatically update the property in existing panel. For example, if I set the default font size to 60px first and then in version 2 of the plugin change it to 50px, existing panels will still have 60px and only new panels will get the new 50px value.</p>

<h2 id="clean-up-after-timeout">Clean up after $timeout</h2>

<p>Now that we know about the event system, we can clean up a potential memory leak. We are using the Angular function $timeout which is a wrapper for setTimeout but that uses promises unlike the core setTimeout function. If we don&rsquo;t cancel it then it can potentially cause problems. We can listen to the <em>panel-teardown</em> event and call cancel to make sure the timeout promise gets destroyed.</p>

<p>We listen to the event in the constructor:</p>
<pre class="highlight javascript"><code><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'panel-teardown'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onPanelTeardown</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
</code></pre>

<p>And then call cancel on teardown:</p>
<pre class="highlight javascript"><code><span class="nx">onPanelTeardown</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">$timeout</span><span class="p">.</span><span class="nx">cancel</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nextTickPromise</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<h2 id="customization-complete">Customization Complete!</h2>

<p>We now have a fully functional panel that shows the time and updates every second. You can customize it and change colors and font sizes, as well as choosing between a 12 and 24 hour clock.</p>

<p>But am I satisfied? No! More features!</p>

<h2 id="more-features-countdown">More features - Countdown</h2>

<p>It&rsquo;s always fun with a countdown to lunch or to launch of a new product. The countdown is very similar to our normal clock. It uses the current time as well and compares it to the end time. The difference between them is the countdown value.</p>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">now</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">timeLeft</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">moment</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">countdownSettings</span><span class="p">.</span><span class="nx">endCountdownTime</span><span class="p">).</span><span class="nx">diff</span><span class="p">(</span><span class="nx">now</span><span class="p">));</span>
</code></pre>

<p>It would also be nice to define the text that shows up when the countdown finishes. This is pretty easy. We need to add it in three places. First add a new default field in the ClockCtrl and then add the field to the editor html and lastly use the value in the module.html template.</p>

<p>There is some text formatting code too if you&rsquo;re interested then check out the <a href="https://github.com/grafana/clock-panel/blob/47ba362d8bd3696c93c4ac65ca28b0a9eb26906e/src/clock_ctrl.js#L94-L128">renderCountdown function in the ClockCtrl class on GitHub</a>.</p>

<p>Now we have a working countdown!</p>

<h2 id="more-features-simple-timezones">More features - Simple Timezones</h2>

<p>Next up timezones. I work in a distributed company and it would be great to know what the time is in New York, Seattle, Perth and Hawaii. Or to know what GMT time is right now (if your servers run on GMT/UTC).</p>

<p>This will be a simple implementation allowing the user to choose an offset from UTC or to just show local time. Remember that inputs have to be parsed to integer values as they are saved as strings.</p>
<pre class="highlight javascript"><code><span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">offsetFromUtc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">now</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">().</span><span class="nx">utcOffset</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">offsetFromUtc</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">now</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>

<p>Now we have a customizable digital Clock Panel with the ability to show times from different time zones.</p>

<h2 id="finished">Finished!</h2>

<p>I think this is as far as I want to take Clock panel for the moment but I am of course open to Pull Requests and feature requests. You can find the <a href="https://github.com/grafana/clock-panel">code on GitHub</a> and the Clock can be installed in Grafana with the Grafana CLI tool:</p>
<pre class="highlight shell"><code>grafana-cli plugins install grafana-clock-panel
</code></pre>

<p>Hopefully this is useful to new plugin authors and please don&rsquo;t hesitate to ask questions if you get stuck.</p>
<hr style="margin-top:30px; margin-bottom:30px"/>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'grafanablog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div><div class="large-3 columns"><br /><h4>Posts</h4><p><a href="/blog/2016/04/15/clock-plugin-p2.html">Timing is Everything. Editor Mode in Grafana 3.0 for the Clock Panel Plugin</a></p><p><a href="/blog/2016/04/08/clock-plugin-p1.html">Timing is Everything. Writing the Clock Panel Plugin for Grafana 3.0</a></p><p><a href="/blog/2016/03/31/grafana-3-0-beta-released.html">Grafana 3.0 Beta Released</a></p><hr /><h4>About Grafana</h4><p>Grafana is an open source metrics dashboard and graph composer for Graphite and InfluxDB</p></div></div></main></section><div id="blueimp-gallery" class="blueimp-gallery blueimp-gallery-controls"><div class="slides"></div><h3 class="title"></h3><a class="prev">‹</a><a class="next">›</a><a class="close">×</a><a class="play-pause"></a><ol class="indicator"></ol></div><footer class="page-footer"><div class="footer-bg"></div><div class="footer-content row text-center"><section class="newsletter"><div class="row"><h3 class="text-center">Get notified of new releases</h3></div><div class="row"><div class="medium-10 large-6 columns medium-offset-1 large-offset-3"><form action="http://grafana.us8.list-manage.com/subscribe/post?u=2aeb5711db2aececc990be536&amp;id=5585d37ecc" class="validate" id="mc-embedded-subscribe-form" method="post" name="mc-embedded-subscribe-form" target="_blank"><div class="row collapse"><div class="medium-10 columns"><input class="email" id="mce-EMAIL" name="EMAIL" placeholder="email address" type="email" value="" /></div><div class="medium-2 columns"><input class="button postfix" id="mc-embedded-subscribe" name="subscribe" type="submit" value="Subscribe" /></div></div></form></div></div></section><div class="footer-social"><span><i class="fa fa-github"></i><a href="https://github.com/grafana/grafana/issues">issue tracker</a> on GitHub</span><span><i class="fa fa-comment"></i><a href="irc://chat.freenode.net/#grafana">#grafana</a> on freenode</span><span><i class="fa fa-twitter"></i><a href="http://twitter.com/grafana">@grafana</a> on Twitter</span><span><i class="fa fa-envelope"></i><a href="mailto:torkel@grafana.org">email</a></span></div><div class="row copyright text-center">&copy; 2015 Torkel Ödegaard &amp; Coding Instinct AB</div></div></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-47280256-1', 'grafana.org');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview', {
 'page': location.pathname + location.search  + location.hash,
});</script></body></html>