/*! Copyright (c) 2011, Lloyd Hilaiel, ISC License */
!function(e){function n(e){try{return JSON&&JSON.parse?JSON.parse(e):new Function("return "+e)()}catch(n){r("ijs")}}function r(e){throw new Error(m[e])}function t(e){return Array.isArray?Array.isArray(e):"[object Array]"===c.call(e)}function a(e){if(null===e)return"null";var n=typeof e;return"object"===n&&t(e)&&(n="array"),n}function l(e,n,r,t,l){var i,p=[],o=">"===n[0]?n[1]:n[0],c=!0;return o.type&&(c=c&&o.type===a(e)),o.id&&(c=c&&o.id===r),c&&o.pf&&(":nth-last-child"===o.pf?t=l-t:t++,0===o.a?c=o.b===t:(i=(t-o.b)%o.a,c=!i&&t*o.a+o.b>=0)),">"!==n[0]&&":root"!==n[0].pc&&p.push(n),c&&(">"===n[0]?n.length>2&&(c=!1,p.push(n.slice(2))):n.length>1&&(c=!1,p.push(n.slice(1)))),[c,p]}function i(e,n,r,a,p,o){var c,m,u=","===e[0]?e.slice(1):[e],s=[],d=!1,f=0,_=0,y=0;for(f=0;f<u.length;f++)for(m=l(n,u[f],a,p,o),m[0]&&(d=!0),_=0;_<m[1].length;_++)s.push(m[1][_]);if(s.length&&"object"==typeof n)if(s.length>=1&&s.unshift(","),t(n))for(f=0;f<n.length;f++)i(s,n[f],r,void 0,f,n.length);else{y=0;for(c in n)n.hasOwnProperty(c)&&y++;f=0;for(c in n)n.hasOwnProperty(c)&&i(s,n[c],r,c,f++,y)}d&&r&&r(n)}function p(e,n){var r=[];return i(e,n,function(e){r.push(e)}),r}function o(e){return{sel:_(e),match:function(e){return p(this.sel,e)},forEach:function(e,n){return i(this.sel,e,n)}}}var c=Object.prototype.toString,m={ijs:"invalid json string",mpc:"multiple pseudo classes (:xxx) not allowed",mepf:"malformed expression in pseudo-function",nmi:"multiple ids not allowed",se:"selector expected",sra:"string required after '.'",uc:"unrecognized char",ujs:"unclosed json string",upc:"unrecognized pseudo class"},u={psc:1,psf:2,typ:3,str:4},s=/^(?:([\r\n\t\ ]+)|([*.,>])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/,d=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,f=function(e,t){t||(t=0);var a=s.exec(e.substr(t));if(!a)return void 0;t+=a[0].length;var l;return a[1]?l=[t," "]:a[2]?l=[t,a[0]]:a[3]?l=[t,u.typ,a[0]]:a[4]?l=[t,u.psc,a[0]]:a[5]?l=[t,u.psf,a[0]]:a[6]?r("upc"):a[7]?l=[t,u.str,n(a[0])]:a[8]?r("ujs"):a[9]&&(l=[t,u.str,a[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]),l},_=function(e){for(var n,r=[],t=0;;){var a=y(e,t);if(r.push(a[1]),a=f(e,t=a[0]),a&&" "===a[1]&&(a=f(e,t=a[0])),!a)break;">"===a[1]?(r.push(">"),t=a[0]):","===a[1]&&(void 0===n?n=[",",r]:n.push(r),r=[],t=a[0])}return n&&n.push(r),n?n:r},y=function(e,n){var t=n,a={},l=f(e,n);for(l&&" "===l[1]&&(t=n=l[0],l=f(e,n)),l&&l[1]===u.typ?(a.type=l[2],l=f(e,n=l[0])):l&&"*"===l[1]&&(l=f(e,n=l[0]));;){if(void 0===l)break;if("."===l[1])l=f(e,n=l[0]),l&&l[1]===u.str||r("sra"),a.id&&r("nmi"),a.id=l[2];else if(l[1]===u.psc)(a.pc||a.pf)&&r("mpc"),":first-child"===l[2]?(a.pf=":nth-child",a.a=0,a.b=1):":last-child"===l[2]?(a.pf=":nth-last-child",a.a=0,a.b=1):a.pc=l[2];else{if(l[1]!==u.psf)break;(a.pc||a.pf)&&r("mpc"),a.pf=l[2];var i=d.exec(e.substr(l[0]));i||r("mepf"),i[5]?(a.a=2,a.b="odd"===i[5]?1:0):i[6]?(a.a=0,a.b=parseInt(i[6],10)):(a.a=parseInt((i[1]?i[1]:"+")+(i[2]?i[2]:"1"),10),a.b=i[3]?parseInt(i[3]+i[4],10):0),l[0]+=i[0].length}l=f(e,n=l[0])}return t===n&&r("se"),[n,a]};e._lex=f,e._parse=_,e.match=function(e,n){return o(e).match(n)},e.forEach=function(e,n,r){return o(e).forEach(n,r)},e.compile=o}("undefined"==typeof exports?window.JSONSelect={}:exports);