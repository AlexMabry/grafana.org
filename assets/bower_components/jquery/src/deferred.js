define(["./core","./var/slice","./callbacks"],function(t,e){"use strict";function n(t){return t}function i(t){throw t}function r(e,n,i){var r;try{e&&t.isFunction(r=e.promise)?r.call(e).done(n).fail(i):e&&t.isFunction(r=e.then)?r.call(e,n,i):n.call(void 0,e)}catch(e){i.call(void 0,e)}}return t.extend({Deferred:function(e){var r=[["notify","progress",t.Callbacks("memory"),t.Callbacks("memory"),2],["resolve","done",t.Callbacks("once memory"),t.Callbacks("once memory"),0,"resolved"],["reject","fail",t.Callbacks("once memory"),t.Callbacks("once memory"),1,"rejected"]],o="pending",s={state:function(){return o},always:function(){return a.done(arguments).fail(arguments),this},"catch":function(t){return s.then(null,t)},pipe:function(){var e=arguments;return t.Deferred(function(n){t.each(r,function(i,r){var o=t.isFunction(e[r[4]])&&e[r[4]];a[r[1]](function(){var e=o&&o.apply(this,arguments);e&&t.isFunction(e.promise)?e.promise().progress(n.notify).done(n.resolve).fail(n.reject):n[r[0]+"With"](this,o?[e]:arguments)})}),e=null}).promise()},then:function(e,o,s){function a(e,r,o,s){return function(){var c=this,u=arguments,d=function(){var d,f;if(!(l>e)){if(d=o.apply(c,u),d===r.promise())throw new TypeError("Thenable self-resolution");f=d&&("object"==typeof d||"function"==typeof d)&&d.then,t.isFunction(f)?s?f.call(d,a(l,r,n,s),a(l,r,i,s)):(l++,f.call(d,a(l,r,n,s),a(l,r,i,s),a(l,r,n,r.notifyWith))):(o!==n&&(c=void 0,u=[d]),(s||r.resolveWith)(c,u))}},f=s?d:function(){try{d()}catch(n){t.Deferred.exceptionHook&&t.Deferred.exceptionHook(n,f.stackTrace),e+1>=l&&(o!==i&&(c=void 0,u=[n]),r.rejectWith(c,u))}};e?f():(t.Deferred.getStackHook&&(f.stackTrace=t.Deferred.getStackHook()),window.setTimeout(f))}}var l=0;return t.Deferred(function(l){r[0][3].add(a(0,l,t.isFunction(s)?s:n,l.notifyWith)),r[1][3].add(a(0,l,t.isFunction(e)?e:n)),r[2][3].add(a(0,l,t.isFunction(o)?o:i))}).promise()},promise:function(e){return null!=e?t.extend(e,s):s}},a={};return t.each(r,function(t,e){var n=e[2],i=e[5];s[e[1]]=n.add,i&&n.add(function(){o=i},r[3-t][2].disable,r[0][2].lock),n.add(e[3].fire),a[e[0]]=function(){return a[e[0]+"With"](this===a?void 0:this,arguments),this},a[e[0]+"With"]=n.fireWith}),s.promise(a),e&&e.call(a,a),a},when:function(n){var i=arguments.length,o=i,s=Array(o),a=e.call(arguments),l=t.Deferred(),c=function(t){return function(n){s[t]=this,a[t]=arguments.length>1?e.call(arguments):n,--i||l.resolveWith(s,a)}};if(1>=i&&(r(n,l.done(c(o)).resolve,l.reject),"pending"===l.state()||t.isFunction(a[o]&&a[o].then)))return l.then();for(;o--;)r(a[o],c(o),l.reject);return l.promise()}}),t});