define(["./core","./var/slice","./callbacks"],function(e,t){return e.extend({Deferred:function(t){var n=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],r="pending",i={state:function(){return r},always:function(){return o.done(arguments).fail(arguments),this},then:function(){var t=arguments;return e.Deferred(function(r){e.each(n,function(n,a){var u=e.isFunction(t[n])&&t[n];o[a[1]](function(){var t=u&&u.apply(this,arguments);t&&e.isFunction(t.promise)?t.promise().done(r.resolve).fail(r.reject).progress(r.notify):r[a[0]+"With"](this===i?r.promise():this,u?[t]:arguments)})}),t=null}).promise()},promise:function(t){return null!=t?e.extend(t,i):i}},o={};return i.pipe=i.then,e.each(n,function(e,t){var a=t[2],u=t[3];i[t[1]]=a.add,u&&a.add(function(){r=u},n[1^e][2].disable,n[2][2].lock),o[t[0]]=function(){return o[t[0]+"With"](this===o?i:this,arguments),this},o[t[0]+"With"]=a.fireWith}),i.promise(o),t&&t.call(o,o),o},when:function(n){var r,i,o,a=0,u=t.call(arguments),s=u.length,l=1!==s||n&&e.isFunction(n.promise)?s:0,c=1===l?n:e.Deferred(),f=function(e,n,i){return function(o){n[e]=this,i[e]=arguments.length>1?t.call(arguments):o,i===r?c.notifyWith(n,i):--l||c.resolveWith(n,i)}};if(s>1)for(r=new Array(s),i=new Array(s),o=new Array(s);s>a;a++)u[a]&&e.isFunction(u[a].promise)?u[a].promise().done(f(a,o,u)).fail(c.reject).progress(f(a,i,r)):--l;return l||c.resolveWith(o,u),c.promise()}}),e});